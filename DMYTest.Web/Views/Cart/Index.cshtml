@using PagedList;
@using PagedList.Mvc;
@model List<DMYTest.Data.Models.Cart>
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/Layout.cshtml";
}
<link href="~/Content/toastr.css" rel="stylesheet" />

<h2 hidden>@Session["Ad"]  @Session["Soyad"]</h2>


@if (Model.Count > 0)
{
    <h3>Sepetim</h3>
    <table class="table table-bordered" id="table">
        <thead>
            <tr>
                <th>Ürün Bilgisi</th>
                <th>Adet</th>
                <th>Birim Fiyatı</th>
                <th>Tarih</th>
                <th>Resim</th>
                <th>Sil</th>
                <th>Toplam Tutar</th>
                <th>Satın Al</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr class="operation">
                    <td>@item.Product.ProductName</td>
                    <td>
                        <div class="update-quantity">
                            <button class="btnIncrease" id="@item.CartID">+</button>
                            <span id="item-quantity">@item.Quantity</span>
                            <button class="btnDecrease" id="@item.CartID">-</button>
                        </div>
                    </td>
                    <td class="unit-price">@item.Product.UnitPrice</td>
                    <td>@Convert.ToDateTime(item.Date).ToString("dd/MM/yyyy")</td>
                    <td>
                        @foreach (var i in item.Product.Images.Where(i => i.ProductID == item.ProductID).Select(X => X.ImagePath).ToList())
                        {
                            <img src="~/Content/Image/@i" width="90" height="90" />
                        }
                    </td>
                    <td><a href="/cart/delete/@item.CartID" class="btn btn-danger" id="item-cartID" onclick="return confirm('Emin misiniz')">Sil</a></td>
                    <td>    <span id="item-price">@item.Price</span> TL</td>
                    <td><a href="/sales/buy/@item.CartID" class="btn btn-success">Satın Al</a></td>
                </tr>
            }
            <p>Toplam Tutar :<span id="item-total-price">@Model.Sum(m => m.Quantity * m.Product.UnitPrice)</span> TL</p>
        </tbody>
    </table>

    <div class="container"> </div>
    <br />

    <div class="container form-group">
        <a href="/sales/buyall/@ViewBag.userID" class="btn btn-success form-control">Tümünü Satın Al</a>
    </div>
    <div class="container form-group">
        <a href="/cart/deleteall" class="btn btn-danger form-control">Hepsini Sil</a>
    </div>
}
else
            {
                <h2>Sepetinizde urun bulunamadi.</h2>
            }
 

<style>
    .update-quantity {
        display: flex;
        align-items: center;
    }

        .update-quantity button {
            margin: 0 5px;
            padding: 5px 10px;
            background-color: #007bff;
            color: #fff;
            border: none;
            cursor: pointer;
        }

            .update-quantity button:hover {
                background-color: #0056b3;
            }
</style>

<script src="~/Scripts/jquery-3.3.1.min.js"></script>
<script src="~/Scripts/toastr.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/5.5.2/bootbox.min.js"></script>

<script type="text/javascript">

    $(document).ready(function () {
        //var cartID = parseInt(document.getElementByClassName('btnIncrease').getAttribute('id');
        
        $("#table").on("click", ".btnIncrease", function () {
            var quantityElement = document.getElementById('item-quantity');
            var priceElement = document.getElementById('item-price');
            increaseQuantity(priceElement, quantityElement);

        });

        $("#table").on("click", ".btnDecrease", function () {
            var quantityElement = document.getElementById('item-quantity');
            var priceElement = document.getElementById('item-price');
            decreaseQuantity(priceElement, quantityElement);

        });


    });
    function increaseQuantity(priceElement, quantityElement) {
        var totalPriceElement = document.getElementById('item-total-price');
        var elements = document.getElementsByClassName('btnIncrease');
        var money = ",00";
        $.ajax({
            url: "/cart/IncreaseQuantity",
            type: "POST",
            data: { cartID: cartID },
            success: function (data) {
                priceElement.innerText = data.currentPrice + money;
                quantityElement.innerText = data.currentQuantity;
                totalPriceElement.innerText = data.currentPrice + money;
                toastr.info(data.message);
            },
            error: function () {

                taostr.error(data.error)
            }
        });
    }

    function decreaseQuantity(priceElement, quantityElement) {
        var totalPriceElement = document.getElementById('item-total-price');
        var cartID = parseInt(document.getElementById('item-cartID').getAttribute('href').split('/').pop());
        var money = ",00"
        $.ajax({
            url: "/cart/decreasequantity",
            type: "POST",
            data: { cartID: cartID },
            success: function (data) {
                priceElement.innerText = data.currentPrice + money;
                quantityElement.innerText = data.currentQuantity;
                totalPriceElement.innerText = data.currentPrice + money;
                toastr.info(data.message);
            },
            error: function () {

                priceElement.innerText = data.currentPrice + money;
                quantityElement.innerText = data.currentQuantity;
                totalPriceElement.innerText = data.currentPrice + money;
                taostr.error(data.error)
            }
        });


    }


</script>
